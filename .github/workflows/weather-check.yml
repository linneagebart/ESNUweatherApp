name: Weather Check

on:
  schedule:
    - cron: '25 5 * * *'   # 06:30 CET
    - cron: '55 8 * * *'   # 09:50 CET
    - cron: '55 11 * * *'   # 13:00 CET
    - cron: '20 13 * * *'  # 14:25 CET
    - cron: '50 14 * * *'  # 15:55 CET
    - cron: '0 19 * * *'   # 20:00 CET
  workflow_dispatch:

jobs:
  check-weather:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch METAR data
        id: fetch
        run: |
          # UmeÃ¥ Airport ICAO code: ESNU
          METAR_RAW=$(curl -s "https://aviationweather.gov/api/data/metar?ids=ESNU&format=raw")
          echo "METAR=${METAR_RAW}" >> $GITHUB_OUTPUT

          # â”€â”€ Temperature & Dew point â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          TEMP_RAW=$(echo "$METAR_RAW" | grep -oE 'M?[0-9]{2}/M?[0-9]{2}' | head -1)
          TEMP_PART=$(echo "$TEMP_RAW" | cut -d'/' -f1)
          DEW_PART=$(echo  "$TEMP_RAW" | cut -d'/' -f2)
          TEMP_C=$(echo "$TEMP_PART" | sed 's/^M/-/' | sed 's/^-0*\([1-9]\)/-\1/' | sed 's/^0*//')
          DEW_C=$(echo  "$DEW_PART"  | sed 's/^M/-/' | sed 's/^-0*\([1-9]\)/-\1/' | sed 's/^0*//')
          # Fallback to 0 if parsing failed (prevents integer comparison errors)
          TEMP_C=${TEMP_C:-0}
          DEW_C=${DEW_C:-0}
          echo "TEMP_C=${TEMP_C}" >> $GITHUB_OUTPUT
          echo "DEW_C=${DEW_C}"   >> $GITHUB_OUTPUT

          # â”€â”€ Observation time â†’ "DD HH:MM UTC" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          TIME_RAW=$(echo "$METAR_RAW" | grep -oE '[0-9]{6}Z' | head -1)
          if [ -n "$TIME_RAW" ]; then
            OBS_DAY=$(echo "$TIME_RAW" | cut -c1-2)
            OBS_HH=$(echo  "$TIME_RAW" | cut -c3-4)
            OBS_MM=$(echo  "$TIME_RAW" | cut -c5-6)
            TIME_TEXT="${OBS_DAY} ${OBS_HH}:${OBS_MM} UTC"
          else
            TIME_TEXT="OkÃ¤nd tid"
          fi
          echo "TIME_TEXT=${TIME_TEXT}" >> $GITHUB_OUTPUT

          # â”€â”€ Wind â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Matches: 18005KT  18005G12KT  VRB03KT  00000KT
          WIND_RAW=$(echo "$METAR_RAW" | grep -oE '(VRB|[0-9]{3})[0-9]{2,3}(G[0-9]{2,3})?KT' | head -1)
          if [ -n "$WIND_RAW" ]; then
            WIND_DIR=$(echo "$WIND_RAW" | grep -oE '^(VRB|[0-9]{3})')
            WIND_KT=$(echo  "$WIND_RAW" | sed 's/^\(VRB\|[0-9]\{3\}\)//' | grep -oE '^[0-9]{2,3}')
            WIND_KT=${WIND_KT:-0}
            WIND_MS=$(echo "scale=1; $WIND_KT * 0.514444" | bc)

            if [ "$WIND_DIR" = "VRB" ]; then
              DIR_TEXT="Variabel"
            elif [ "$WIND_DIR" = "000" ] && [ "$WIND_KT" = "00" ]; then
              DIR_TEXT="Stiltje"
              WIND_MS="0.0"
            else
              DEG=$((10#$WIND_DIR))
              IDX=$(( (DEG + 22) / 45 % 8 ))
              case $IDX in
                0) DIR_TEXT="Nord"    ;;
                1) DIR_TEXT="Nordost" ;;
                2) DIR_TEXT="Ã–st"     ;;
                3) DIR_TEXT="Sydost"  ;;
                4) DIR_TEXT="Syd"     ;;
                5) DIR_TEXT="SydvÃ¤st" ;;
                6) DIR_TEXT="VÃ¤st"    ;;
                7) DIR_TEXT="NordvÃ¤st";;
              esac
            fi

            if [ "$DIR_TEXT" = "Stiltje" ]; then
              WIND_TEXT="Vind: Stiltje"
            else
              WIND_TEXT="Vind: ${DIR_TEXT} (${WIND_DIR}Â°) ${WIND_MS} m/s"
            fi

            GUST_KT=$(echo "$WIND_RAW" | grep -oE 'G([0-9]{2,3})KT' | grep -oE '[0-9]{2,3}' | head -1)
            if [ -n "$GUST_KT" ]; then
              GUST_MS=$(echo "scale=1; $GUST_KT * 0.514444" | bc)
              WIND_TEXT="${WIND_TEXT}, byar ${GUST_MS} m/s"
            fi
          else
            WIND_TEXT="Vind: Ej tillgÃ¤nglig"
          fi
          echo "WIND_TEXT=${WIND_TEXT}" >> $GITHUB_OUTPUT

          # â”€â”€ Visibility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # CAVOK = ceiling and visibility OK (â‰¥10 km, no cloud below 1500m, no CB)
          # 9999  = â‰¥ 10 km; other 4-digit values are meters
          if echo "$METAR_RAW" | grep -qE '\bCAVOK\b'; then
            VIS_TEXT="Sikt: â‰¥ 10 km"
          else
            VIS_RAW=$(echo "$METAR_RAW" | grep -oE '\b(9999|[0-9]{4})\b' | head -1)
            if [ -n "$VIS_RAW" ]; then
              VIS_INT=$((10#$VIS_RAW))
              if [ "$VIS_INT" -eq 9999 ]; then
                VIS_TEXT="Sikt: â‰¥ 10 km"
              elif [ "$VIS_INT" -ge 500 ]; then
                VIS_KM=$(echo "scale=1; $VIS_INT / 1000" | bc)
                VIS_TEXT="Sikt: ${VIS_KM} km"
              else
                VIS_TEXT="Sikt: ${VIS_INT} m âš ï¸"
              fi
            else
              VIS_TEXT="Sikt: Ej tillgÃ¤nglig"
            fi
          fi
          echo "VIS_TEXT=${VIS_TEXT}" >> $GITHUB_OUTPUT

          # â”€â”€ Clouds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # CAVOK = inga moln under 1500 m, inga cumulonimbus
          # Height code = hundreds of feet; convert to meters
          if echo "$METAR_RAW" | grep -qE '\bCAVOK\b'; then
            CLOUD_LINES="Inga moln under 1500 m\n"
          else
            CLOUD_LINES=""
            while IFS= read -r TOKEN; do
              [ -z "$TOKEN" ] && continue
              CODE=$(echo "$TOKEN" | grep -oE '^(FEW|SCT|BKN|OVC|NCD|NSC|SKC|CLR)')
              HGT=$(echo  "$TOKEN" | grep -oE '[0-9]+$')

              case $CODE in
                FEW) SWE="NÃ¥gra moln"                 ;;
                SCT) SWE="Spridda moln"               ;;
                BKN) SWE="Molnigt"                    ;;
                OVC) SWE="Mulet"                      ;;
                NCD|NSC) SWE="Inga signifikanta moln" ;;
                SKC|CLR) SWE="Klar himmel"            ;;
                *)   SWE="$CODE"                      ;;
              esac

              if [ -n "$HGT" ] && [ "$((10#$HGT))" -gt 0 ]; then
                HGT_M=$(echo "scale=0; $((10#$HGT)) * 100 * 3048 / 10000" | bc)
                HGT_FT=$(( 10#$HGT * 100 ))
                CLOUD_LINES="${CLOUD_LINES}${SWE} vid ${HGT_M} m (${HGT_FT} ft)\n"
              else
                CLOUD_LINES="${CLOUD_LINES}${SWE}\n"
              fi
            done <<< "$(echo "$METAR_RAW" | grep -oE '(FEW|SCT|BKN|OVC|NCD|NSC|SKC|CLR)[0-9]*')"

            [ -z "$CLOUD_LINES" ] && CLOUD_LINES="Molninfo ej tillgÃ¤nglig\n"
          fi

          {
            echo "CLOUDS_TEXT<<ENDOFCLOUDS"
            echo -e "Moln: ${CLOUD_LINES}"
            echo "ENDOFCLOUDS"
          } >> $GITHUB_OUTPUT

      - name: Send notification
        run: |
          TEMP="${{ steps.fetch.outputs.TEMP_C }}"
          DEW="${{  steps.fetch.outputs.DEW_C }}"
          TIME="${{ steps.fetch.outputs.TIME_TEXT }}"
          METAR="${{ steps.fetch.outputs.METAR }}"
          WIND="${{ steps.fetch.outputs.WIND_TEXT }}"
          VIS="${{  steps.fetch.outputs.VIS_TEXT }}"
          CLOUDS="${{ steps.fetch.outputs.CLOUDS_TEXT }}"

          # Guard against empty TEMP (fallback to 0)
          TEMP=${TEMP:-0}

          TITLE="UmeÃ¥ VÃ¤der"
          MESSAGE="Temperatur: ${TEMP}Â°C"

          # â”€â”€ Weather condition checks (order matters!) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if echo "$METAR" | grep -qE '(^|\s)\+SN(\s|$)'; then
            TITLE="IT's FUCKING SNOOOWING! â˜ƒï¸â„ï¸â„ï¸â„ï¸"
            MESSAGE="Om du inte ser snÃ¶n nu sÃ¥ vet jag inte vem jag ska ringa...â˜ƒï¸â„ï¸â„ï¸â„ï¸"

          elif echo "$METAR" | grep -qE '(^|\s)-SN(\s|$)'; then
            TITLE="LÃ¤tt snÃ¶fall â˜ƒï¸â„ï¸"
            MESSAGE="DET SNÃ–AR VISST HENKE, KOLLA UT GENOM FÃ–NSTRET. â˜ƒï¸â„ï¸"

          elif echo "$METAR" | grep -qE '(^|\s)SN(\s|$)'; then
            TITLE="Jag ser de snÃ¶ar! â˜ƒï¸ğŸ¶â„ï¸â„ï¸"
            MESSAGE="DET SNÃ–AR Ã„NNU MER NU HENKE, KOLLA UT!!â˜ƒï¸ğŸ¶â„ï¸â„ï¸"

          elif echo "$METAR" | grep -qE '(^|\s)\+RA(\s|$)'; then
            TITLE="IT'S RAINING MEN ğŸŒ§ï¸ğŸŒ§ï¸ğŸŒ§ï¸ğŸŒ§ï¸ğŸŒ§ï¸"
            MESSAGE="IT'S RAINING MEN ğŸŒ§ï¸ğŸŒ§ï¸ğŸŒ§ï¸ğŸŒ§ï¸ğŸŒ§ï¸"

          elif echo "$METAR" | grep -qE '(^|\s)-RA(\s|$)'; then
            TITLE="IT'S RAINING MEN ğŸŒ§ï¸ğŸŒ§ï¸"
            MESSAGE="IT'S RAINING MEN ğŸŒ§ï¸ğŸŒ§ï¸"

          elif echo "$METAR" | grep -qE '(^|\s)RA(\s|$)'; then
            TITLE="IT'S RAINING MEN ğŸŒ§ï¸ğŸŒ§ï¸ğŸŒ§ï¸"
            MESSAGE="IT'S RAINING MEN ğŸŒ§ï¸ğŸŒ§ï¸ğŸŒ§ï¸"

          elif [ "${TEMP}" -le -20 ]; then
            TITLE="Welcome to Yakutsk! ğŸ¥¶â˜ƒï¸â„ï¸ğŸŒ¬ï¸"
            MESSAGE="Temperatur: ${TEMP}Â°C"

          elif [ "${TEMP}" -gt -20 ] && [ "${TEMP}" -le -5 ]; then
            TITLE="Ingen sommarvÃ¤rme Ã¤n ğŸ˜¶â€ğŸŒ«ï¸ğŸ¥ºâ›„ï¸"
            MESSAGE="Temperatur: ${TEMP}Â°C"

          elif [ "${TEMP}" -gt -5 ] && [ "${TEMP}" -le 10 ]; then
            TITLE="VÃ¥ren Ã¤r hÃ¤r ğŸŒ¸ğŸ‘"
            MESSAGE="Temperatur: ${TEMP}Â°C"

          elif [ "${TEMP}" -ge 30 ] && echo "$METAR" | grep -qE 'NCD|SKC|CLR|FEW'; then
            TITLE="Sun is shining, summer is here â˜€ï¸â˜€ï¸â˜€ï¸â˜€ï¸â˜€ï¸ğŸï¸ğŸ–ï¸"
            MESSAGE="Temperatur: ${TEMP}Â°C"

          elif [ "${TEMP}" -ge 28 ] && echo "$METAR" | grep -qE 'NCD|SKC|CLR|FEW'; then
            TITLE="Sun is shining, summer is here â˜€ï¸â˜€ï¸â˜€ï¸â˜€ï¸â˜€ï¸"
            MESSAGE="Temperatur: ${TEMP}Â°C"

          elif [ "${TEMP}" -ge 26 ] && echo "$METAR" | grep -qE 'NCD|SKC|CLR|FEW'; then
            TITLE="Sun is shining, summer is here â˜€ï¸â˜€ï¸â˜€ï¸â˜€ï¸"
            MESSAGE="Temperatur: ${TEMP}Â°C"

          elif [ "${TEMP}" -ge 24 ] && echo "$METAR" | grep -qE 'NCD|SKC|CLR|FEW'; then
            TITLE="Sun is shining, summer is here â˜€ï¸â˜€ï¸â˜€ï¸"
            MESSAGE="Temperatur: ${TEMP}Â°C"

          elif [ "${TEMP}" -ge 22 ] && echo "$METAR" | grep -qE 'NCD|SKC|CLR|FEW'; then
            TITLE="Sun is shining, summer is here â˜€ï¸â˜€ï¸"
            MESSAGE="Temperatur: ${TEMP}Â°C"

          elif [ "${TEMP}" -ge 20 ] && echo "$METAR" | grep -qE 'NCD|SKC|CLR|FEW'; then
            TITLE="Sun is shining, summer is here â˜€ï¸"
            MESSAGE="Temperatur: ${TEMP}Â°C"

          else
            TITLE="UmeÃ¥ VÃ¤der ğŸŒ¤ï¸ğŸï¸"
            MESSAGE="Temperatur: ${TEMP}Â°C"
          fi

          curl -H "Title: ${TITLE}" \
               -H "Priority: default" \
               -d "${MESSAGE}

          Temperatur: ${TEMP}Â°C (Daggpunkt: ${DEW}Â°C)
          ${WIND}
          ${VIS}
          ${CLOUDS}

          Observerad: ${TIME}" \
               https://ntfy.sh/lgweatherappESNU
